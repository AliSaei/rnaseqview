var Ideogram=function(e){this.config=JSON.parse(JSON.stringify(e));this.debug=!1;this.config.container||(this.config.container="body");this.config.resolution||(this.config.resolution=850);this.config.brush||(this.config.brush=!1);this.config.rows||(this.config.rows=1);!1==="chrHeight"in e&&(e.chrHeight=500);this.bump=Math.round(e.chrHeight/125);this.adjustedBump=!1;200>e.chrHeight&&(this.adjustedBump=!0,this.bump=4);e.showBandLabels&&(this.config.chrMargin+=20);this.config.annotationsPath||this.config.localAnnotationsPath?
(this.config.annotationHeight||(this.config.annotationHeight=3),this.config.numAnnotTracks=this.config.annotationTracks?this.config.annotationTracks.length:1,this.config.annotTracksHeight=this.config.annotationHeight*this.config.numAnnotTracks,"undefined"===typeof this.config.barWidth&&(this.config.barWidth=3),"undefined"===typeof this.config.annotationsColor&&(this.config.annotationsColor="#F00")):this.config.annotTracksHeight=0;this.config.chrMargin=this.config.chrMargin+this.config.chrWidth+2*
this.config.annotTracksHeight;e.onLoad&&(this.onLoadCallback=e.onLoad);e.onDrawAnnots&&(this.onDrawAnnotsCallback=e.onDrawAnnots);e.onBrushMove&&(this.onBrushMoveCallback=e.onBrushMove);this.coordinateSystem="iscn";this.maxLength={bp:0,iscn:0};this.organisms={9606:{commonName:"Human",scientificName:"Homo sapiens",scientificNameAbbr:"H. sapiens"},10090:{commonName:"Mouse",scientificName:"Mus musculus",scientificNameAbbr:"M. musculus"},7227:{commonName:"Fly",scientificName:"Drosophlia melanogaster",
scientificNameAbbr:"D. melanogaster"}};this.config.annotationsPath&&!this.config.annotationHeight&&(this.config.annotationHeight=3);this.chromosomesArray=[];this.bandsToShow=[];this.chromosomes={};this.bandData={};this.init()};
Ideogram.prototype.getBands=function(e,f,a){var c=[],b,d,h,g,k,l;"undefined"===typeof chrBands?(delimiter=/\t/,e=e.split(/\r\n|\n/),h=1):(delimiter=/ /,h=0);g=e[0].split(delimiter)[0];b="#chromosome"==g?"ncbi":"#chrom"==g?"ucsc":"native";g=e.length;if("ncbi"===b||"native"===b)for(;h<g;h++)b=e[h].split(delimiter),b[0]===f&&(d=b[7],b[8]&&(d+=b[8]),b={chr:b[0],bp:{start:parseInt(b[5],10),stop:parseInt(b[6],10)},iscn:{start:parseInt(b[3],10),stop:parseInt(b[4],10)},px:{start:-1,stop:-1,width:-1},name:b[1]+
b[2],stain:d,taxid:a},c.push(b));else if("ucsc"===b)for(;h<g;h++)b=e[h].split(delimiter),b[0]==="chr"+f&&(d=b[4],"n/a"===d&&(d="gpos100"),k=parseInt(b[1],10),l=parseInt(b[2],10),b={chr:b[0].split("chr")[1],bp:{start:k,stop:l},iscn:{start:k,stop:l},px:{start:-1,stop:-1,width:-1},name:b[3],stain:d,taxid:a},c.push(b));return c};
Ideogram.prototype.getChromosomeModel=function(e,f,a,c){var b={},d=this.config.chrHeight,h=this.maxLength,g;g=this.coordinateSystem;b.chrIndex=c;b.name=f;!0===this.config.fullChromosomeLabels&&(b.name=this.organisms[a].scientificNameAbbr+" chr"+b.name);b.id="chr"+f+"-"+a;b.length=e[e.length-1][g].stop;c=b.length;for(var k=pxStop=0;k<e.length;k++)f=e[k],a=d*b.length/h[g]*(f[g].stop-f[g].start)/c,e[k].px={start:pxStop,stop:pxStop+a,width:a},pxStop=e[k].px.stop,"acen"===f.stain&&"p"===f.name[0]&&(b.pcenIndex=
k);b.width=pxStop;b.scale={};!0===this.config.multiorganism?(b.scale.bp=1,b.scale.iscn=d*c/h.bp):(b.scale.bp=d/h.bp,b.scale.iscn=d/h.iscn);b.bands=e;b.centromerePosition="";1==e[0].bp.stop-e[0].bp.start&&(b.centromerePosition="telocentric",b.bands=b.bands.slice(1));return b};
Ideogram.prototype.drawChromosomeLabels=function(e){var f,a;f=this;e=f.chromosomesArray;a=f.config.chrMargin-f.config.chrWidth-2;"vertical"===f.config.orientation&&!0===f.config.showBandLabels&&(a=f.config.chrMargin+8);"vertical"===f.config.orientation?d3.selectAll(".chromosome").append("text").data(e).attr("class","chrLabel").attr("transform","rotate(-90)").attr("y",-16).each(function(c,b){var d,e;d=c.name.split(" ");var g=[];if(void 0!=d)for(g.push(d.slice(0,d.length-1).join(" ")),g.push(d[d.length-
1]),f.config.showBandLabels||(b+=1),d=f.config.chrMargin*b,d=-(d+a)+3+2*f.config.annotTracksHeight,b=0;b<g.length;b++)e="",0==b&&f.config.fullChromosomeLabels&&(e="italic"),d3.select(this).append("tspan").text(g[b]).attr("dy",b?"1.2em":0).attr("x",d).attr("text-anchor","middle").attr("class",e)}):d3.selectAll(".chromosome").append("text").data(e).attr("class","chrLabel").attr("x",-5).each(function(c,b){var d,e;d=c.name.split(" ");var g=[];if(void 0!=d)for(g.push(d.slice(0,d.length-1).join(" ")),g.push(d[d.length-
1]),d=f.config.chrMargin*b,d=d+a+9,b=0;b<g.length;b++)e="",0==b&&f.config.fullChromosomeLabels&&(e="italic"),d3.select(this).append("tspan").text(g[b]).attr("dy",b?"1.2em":0).attr("y",d).attr("x",-8).attr("text-anchor","middle").attr("class",e)})};
Ideogram.prototype.drawBandLabels=function(e){var f,a,c,b;b=this;a=[];for(c in e)for(f in e[c])a.push(e[c][f]);var d={};for(e=chrIndex=0;e<a.length;e++){chrIndex+=1;chrModel=a[e];f=d3.select("#"+chrModel.id);var h=this.config.chrMargin*chrIndex,g;b=this;g=h;1==chrIndex&&"perspective"in this.config&&"comparative"==this.config.perspective&&(g+=18);d[chrModel.id]=[];f.selectAll("text").data(chrModel.bands).enter().append("g").attr("class",function(a,c){return"bandLabel bsbsl-"+c}).attr("transform",function(a){a=
b.round(-8+a.px.start+a.px.width/2);d[chrModel.id].push(a+13);return"translate("+a+","+(h-10)+")"}).append("text").text(function(a){return a.name});f.selectAll("line.bandLabelStalk").data(chrModel.bands).enter().append("g").attr("class",function(a,c){return"bandLabelStalk bsbsl-"+c}).attr("transform",function(a){return"translate("+b.round(a.px.start+a.px.width/2)+", "+g+")"}).append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",-8)}for(e=0;e<a.length;e++){chrModel=a[e];var k=d[chrModel.id].length,
l;c=[];var m,n,q;for(f=l=0;f<k;f++)n=d[chrModel.id][f],!1===n<l+5?(c.push(f),m!==f&&(prevTextBoxLeft=d[chrModel.id][f],prevTextBoxWidth=36,q=prevTextBoxLeft+prevTextBoxWidth),n<q+5?(m=f,l=q):c.push(f)):(m=f,l=q);k=[];l=c.length;for(n=0;n<l;n++)f=c[n],k.push("#"+chrModel.id+" .bsbsl-"+f);this.bandsToShow=this.bandsToShow.concat(k)}};
Ideogram.prototype.rotateChromosomeLabels=function(e,f,a,c){var b,d,h,g,k,l,m,n;d=this.config.chrWidth;b=this.config.chrMargin*f;l=this.config.numAnnotTracks;h=this;"undefined"===typeof c||!c.hasOwnProperty("x")||1==c.x&&1==c.y?(g=-8,k=-16,c={x:1,y:1},m=""):(m="scale("+c.x+","+c.y+")",g=-6,k=""===c?-16:-14);"vertical"==a||""==a?e.selectAll("text.chrLabel").attr("transform",m).selectAll("tspan").attr("x",g).attr("y",function(c,b){var e=f-1;(1<l||""==a)&&--e;chrMargin2=-4;!0===h.config.showBandLabels&&
(chrMargin2=h.config.chrMargin+d+26);e*=h.config.chrMargin;0==1<l&&(e+=1);return e+chrMargin2}):(--f,chrMargin2=-d-2,!0===h.config.showBandLabels&&(chrMargin2=h.config.chrMargin+8),n=h.config.annotTracksHeight,"overlay"!==h.config.annotationsLayout&&(n*=2),e.selectAll("text.chrLabel").attr("transform","rotate(-90)"+m).selectAll("tspan").attr("x",function(a,d){b=h.config.chrMargin*f;g=-(b+chrMargin2)+3+n;return g/=c.x}).attr("y",k))};
Ideogram.prototype.rotateBandLabels=function(e,f,a){var c,b,d,h,g=this;h=e.selectAll(".bandLabel");c=this.config.chrMargin*f;d=e.attr("data-orientation");"undefined"==typeof a?(a={x:1,y:1},b=""):b="scale("+a.x+","+a.y+")";1==f&&"perspective"in this.config&&"comparative"==this.config.perspective?h.attr("transform",function(a){var b;b=8-c-26;a=g.round(2+a.px.start+a.px.width/2);return"rotate(-90)translate("+b+","+a+")"}).selectAll("text").attr("text-anchor","end"):"vertical"==d?h.attr("transform",function(a){var b;
b=8-c;a=g.round(2+a.px.start+a.px.width/2);return"rotate(-90)translate("+b+","+a+")"}).selectAll("text").attr("transform",b):(h.attr("transform",function(b){return"translate("+g.round(-8*a.x+b.px.start+b.px.width/2)+","+(c-10)+")"}).selectAll("text").attr("transform",b),e.selectAll(".bandLabelStalk line").attr("transform",b))};Ideogram.prototype.round=function(e){return Math.round(100*e)/100};
Ideogram.prototype.drawChromosome=function(e,f){var a,c,b,d,h,g,k,l;k=this;g=k.bump;h="telocentric"!=e.centromerePosition?g:Math.round(g/4)+3;a=d3.select("svg").append("g").attr("id",e.id).attr("class","chromosome");c=k.config.chrWidth;var m=k.config.chrMargin*f;a.selectAll("path").data(e.bands).enter().append("path").attr("id",function(a){a=a.name.replace(".","-");return e.id+"-"+a}).attr("class",function(a){var b="band "+a.stain;"acen"==a.stain&&(b+=" "+a.name[0]+"-cen");return b}).attr("d",function(a,
b){var d=k.round(a.px.width),f=k.round(a.px.start),n,l,p;p=0;"acen"==a.stain?(k.adjustedBump?(p=.35,d=.2,f-=.1,"q"===a.name[0]&&(f+=1.2)):d-=g/2,n=m+p,l=c/2-2*p,p=c-2*p,"p"==a.name[0]?a="M "+f+" "+n+" l "+d+" 0 q "+g+" "+l+" 0 "+p+" l -"+d+" 0 z":(k.adjustedBump&&(d+=.2),a="M "+(f+d+g/2)+" "+n+" l -"+d+" 0 q -"+(g+.5)+" "+l+" 0 "+p+" l "+d+" 0 z")):(0==b&&(f+=h-g/2,!0===k.config.multiorganism&&(f+=h)),k.adjustedBump&&"q"===a.name[0]&&(f+=1.8),b==e.bands.length-1&&(f-=h-g/2),a="M "+f+" "+m+" l "+d+
" 0 l 0 "+c+" l -"+d+" 0 z");return a});"telocentric"!=e.centromerePosition?a.append("path").attr("class","p-ter chromosomeBorder "+e.bands[0].stain).attr("d","M "+(h-g/2+.1)+" "+m+" q -"+h+" "+c/2+" 0 "+c):(a.append("path").attr("class","p-ter chromosomeBorder "+e.bands[0].stain).attr("d","M "+(h-3)+" "+m+" l -"+(h-2)+" 0 l 0 "+c+" l "+(h-2)+" 0 z"),a.insert("path",":first-child").attr("class","acen").attr("d","M "+(h-3)+" "+(m+.1*c)+" l "+(h+g/2+1)+" 0 l 0 "+.8*c+" l -"+(h+g/2+1)+" 0 z"));l=k.adjustedBump?
1.8:0;b=e.pcenIndex;var n=e.bands[b];d=e.bands[b+1];0<b?(b=n.px.start,d=d.px.stop+l):(b=2,d=document.querySelectorAll("#"+e.id+" .band")[0].getBBox().x);l=d+(e.width-d+1.3*l)-g/2-.5;a.append("line").attr("class","cb-p-arm-top chromosomeBorder").attr("x1",g/2).attr("y1",m).attr("x2",b).attr("y2",m);a.append("line").attr("class","cb-p-arm-bottom chromosomeBorder").attr("x1",g/2).attr("y1",c+m).attr("x2",b).attr("y2",c+m);a.append("line").attr("class","cb-q-arm-top chromosomeBorder").attr("x1",d).attr("y1",
m).attr("x2",l).attr("y2",m);a.append("line").attr("class","cb-q-arm-bottom chromosomeBorder").attr("x1",d).attr("y1",c+m).attr("x2",l).attr("y2",c+m);a.append("path").attr("class","q-ter chromosomeBorder "+e.bands[e.bands.length-1].stain).attr("d","M "+l+" "+m+" q "+g+" "+c/2+" 0 "+c)};
Ideogram.prototype.initTransformChromosome=function(e,f){if("vertical"==this.config.orientation){var a,c;c=this.config.chrWidth;a=this.config.chrMargin*f;this.config.showBandLabels||(f+=2);a+=(c-4)*(f-1);e.attr("data-orientation","vertical").attr("transform","rotate(90, "+(a-30)+", "+a+")");this.rotateBandLabels(e,f)}else e.attr("data-orientation","horizontal")};
Ideogram.prototype.rotateAndToggleDisplay=function(e){var f,a,c,b,d,h,g,k,l=this;f=d3.select("#"+e);a=l.chromosomes[l.config.taxid][e.split("-")[0].split("chr")[1]].chrIndex;otherChrs=d3.selectAll("g.chromosome").filter(function(a,b){return this.id!==e});g=l.config.orientation;k=f.attr("data-orientation");c=this.config.chrMargin*a;b=this.config.chrWidth;d=d3.select("#ideogram")[0][0].getBoundingClientRect();h=d.height;d=d.width;"vertical"==g?(chrLength=f[0][0].getBoundingClientRect().height,h=d/chrLength*
.97,scale="scale("+h+", 1.5)",inverseScaleX=2/h,inverseScaleY=1,this.config.showBandLabels||(a+=2),b=c+(b-4)*(a-1)-30,verticalTransform="rotate(90, "+b+", "+(b+30)+")",c=-1.5*(c-this.config.annotTracksHeight),this.config.showBandLabels&&(c+=25),horizontalTransform="rotate(0)translate(20, "+c+")"+scale):(chrLength=f[0][0].getBoundingClientRect().width,h=h/chrLength*.97,scale="scale("+h+", 1.5)",inverseScaleX=2/h,inverseScaleY=1,h=20,this.config.showBandLabels||(a+=2,h=15),b=c+(b-h)*(a-2),c=b+5,this.config.showBandLabels||
(b+=h,c+=h),verticalTransform="rotate(90, "+b+", "+c+")"+scale,horizontalTransform="");inverseScale="scale("+inverseScaleX+","+inverseScaleY+")";"vertical"!=k?("horizontal"==g&&otherChrs.style("display","none"),f.selectAll(".annot>path").attr("transform","vertical"==g?"":inverseScale),f.attr("data-orientation","vertical").transition().attr("transform",verticalTransform).each("end",function(){scale="vertical"==g?"":{x:inverseScaleY,y:inverseScaleX};l.rotateBandLabels(f,a,scale);l.rotateChromosomeLabels(f,
a,"horizontal",scale);"vertical"==g&&otherChrs.style("display","")})):(f.attr("data-orientation",""),"vertical"==g&&otherChrs.style("display","none"),f.selectAll(".annot>path").transition().attr("transform","vertical"==g?inverseScale:""),f.transition().attr("transform",horizontalTransform).each("end",function(){inverseScale="horizontal"==g?"vertical"==k?{x:1,y:1}:"":{x:inverseScaleX,y:inverseScaleY};l.rotateBandLabels(f,a,inverseScale);l.rotateChromosomeLabels(f,a,"",inverseScale);"horizontal"==g&&
otherChrs.style("display","")}))};Ideogram.prototype.convertBpToPx=function(e,f){var a,c;for(a=0;a<e.bands.length;a++)if(c=e.bands[a],f>=c.bp.start&&f<=c.bp.stop)return a=(c.iscn.stop-c.iscn.start)/(c.bp.stop-c.bp.start),a=c.iscn.start+(f-c.bp.start)*a,c=30+c.px.start+c.px.width*(a-c.iscn.start)/(c.iscn.stop-c.iscn.start);throw Error("Base pair out of range.  bp: "+f+"; length of chr"+e.name+": "+c.bp.stop);};
Ideogram.prototype.convertPxToBp=function(e,f){var a,c;for(a=0;a<e.bands.length;a++)if(c=e.bands[a],f>=c.px.start&&f<=c.px.stop)return pxToIscnScale=(c.iscn.stop-c.iscn.start)/(c.px.stop-c.px.start),a=c.iscn.start+(f-c.px.start)*pxToIscnScale,bp=c.bp.start+(c.bp.stop-c.bp.start)*(a-c.iscn.start)/(c.iscn.stop-c.iscn.start),Math.round(bp);throw Error("Pixel out of range.  px: "+bp+"; length of chr"+e.name+": "+c.px.stop);};
Ideogram.prototype.drawSynteny=function(e){var f=(new Date).getTime(),a,c,b,d,h,g,k,l,m;h=d3.select("svg").append("g").attr("class","synteny");for(g=0;g<e.length;g++)regions=e[g],a=regions.r1,c=regions.r2,k="#CFC","color"in regions&&(k=regions.color),l=1,"opacity"in regions&&(l=regions.opacity),a.startPx=this.convertBpToPx(a.chr,a.start),a.stopPx=this.convertBpToPx(a.chr,a.stop),c.startPx=this.convertBpToPx(c.chr,c.start),c.stopPx=this.convertBpToPx(c.chr,c.stop),b=document.querySelectorAll("#"+a.chr.id+
" path")[0].getBBox(),d=document.querySelectorAll("#"+c.chr.id+" path")[0].getBBox(),b=b.y-30,d=d.y-29,m=a.chr.id+"_"+a.start+"_"+a.stop+"___"+c.chr.id+"_"+c.start+"_"+c.stop,syntenicRegion=h.append("g").attr("class","syntenicRegion").attr("id",m).on("click",function(){var a=this,b=d3.selectAll(".syntenicRegion").filter(function(b,c){return this!==a});b.classed("hidden",!b.classed("hidden"))}).on("mouseover",function(){var a=this;d3.selectAll(".syntenicRegion").filter(function(b,c){return this!==
a}).classed("ghost",!0)}).on("mouseout",function(){d3.selectAll(".syntenicRegion").classed("ghost",!1)}),syntenicRegion.append("polygon").attr("points",b+", "+a.startPx+" "+b+", "+a.stopPx+" "+d+", "+c.stopPx+" "+d+", "+c.startPx).attr("style","fill: "+k+"; fill-opacity: "+l),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",b).attr("x2",d).attr("y1",a.startPx).attr("y2",c.startPx),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",b).attr("x2",d).attr("y1",
a.stopPx).attr("y2",c.stopPx);e=(new Date).getTime();this.debug&&console.log("Time in drawSyntenicRegions: "+(e-f)+" ms")};
Ideogram.prototype.processAnnotData=function(e){var f=e.keys;e=e.annots;var a,c,b,d,h,g,k;d=[];for(a=0;a<e.length;a++)for(annotsByChr=e[a],d.push({chr:annotsByChr.chr,annots:[]}),c=0;c<annotsByChr.annots.length;c++){h=annotsByChr.chr;ra=annotsByChr.annots[c];b={};for(k=0;k<f.length;k++)b[f[k]]=ra[k];b.stop=b.start+b.length;g=this.chromosomes["9606"][h];k=this.convertBpToPx(g,b.start);g=this.convertBpToPx(g,b.stop);k=Math.round((k+g)/2)-28;g=this.config.annotationsColor;this.config.annotationTracks?
(b.trackIndex=ra[3],g=this.config.annotationTracks[b.trackIndex].color):b.trackIndex=0;b.chr=h;b.chrIndex=a;b.px=k;b.color=g;d[a].annots.push(b)}return d};
Ideogram.prototype.getHistogramBars=function(e){var f=(new Date).getTime(),a,c,b,d,h,g,k,l,m,n;l=[];g=this.config.barWidth;d=this.chromosomes[this.config.taxid];c=this.config.annotationsColor;for(b in d){chrModel=d[b];k=chrModel.chrIndex;lastBand=chrModel.bands[chrModel.bands.length-1];a=lastBand.px.stop;numBins=Math.round(a/g);m={chr:b,annots:[]};for(a=0;a<numBins;a++)h=a*g-this.bump,bp=this.convertPxToBp(chrModel,h+this.bump),m.annots.push({bp:bp,px:h,count:0,chrIndex:k,chrName:b,color:c});l.push(m)}for(b in e)for(g=
e[b].annots,a=e[b].chr,chrModel=d[a],k=chrModel.chrIndex,barAnnots=l[k-1].annots,a=0;a<g.length;a++)for(h=g[a],h=h.px,c=0;c<barAnnots.length-1;c++)if(m=barAnnots[c].px,n=barAnnots[c+1].px,h>m&&h<n){l[k-1].annots[c].count+=1;break}for(a=b=0;a<l.length;a++)for(e=l[a].annots,c=0;c<e.length;c++)barCount=e[c].count,barCount>b&&(b=barCount);for(a=0;a<l.length;a++)for(e=l[a].annots,c=0;c<e.length;c++)barCount=e[c].count,height=barCount/b*this.config.chrMargin,l[a].annots[c].height=height;e=(new Date).getTime();
this.debug&&console.log("Time spent in getHistogramBars: "+(e-f)+" ms");return l};
Ideogram.prototype.drawAnnots=function(e){var f,a,c,b,d,h,g,k,l,m=this;f=this.config.chrMargin;a=this.config.chrWidth;c="tracks";this.config.annotationsLayout&&(c=this.config.annotationsLayout);"histogram"===c&&(e=m.getHistogramBars(e));b=this.config.annotationHeight;d="l -"+b+" "+2*b+" l "+2*b+" 0 z";e=d3.selectAll(".chromosome").data(e).selectAll("path.annot").data(function(a){return a.annots}).enter();"tracks"===c?e.append("g").attr("id",function(a,b){return a.id}).attr("class","annot").attr("transform",
function(c){return"translate("+c.px+","+((c.chrIndex+1)*f+a+c.trackIndex*b*2)+")"}).append("path").attr("d","m0,0"+d).attr("fill",function(a){return a.color}):"overlay"===c?e.append("polygon").attr("id",function(a,b){return a.id}).attr("class","annot").attr("points",function(b){h=b.px-.5;g=b.px+.5;k=(b.chrIndex+1)*f+a;l=(b.chrIndex+1)*f;return h+","+k+" "+g+","+k+" "+g+","+l+" "+h+","+l}).attr("fill",function(a){return a.color}):"histogram"===c&&e.append("polygon").attr("class","annot").attr("points",
function(b){h=b.px+m.bump;g=b.px+m.config.barWidth+m.bump;k=b.chrIndex*f+a;l=b.chrIndex*f+a+b.height;b=m.chromosomesArray[b.chrIndex-1].width;g>b&&(g=b);return h+","+k+" "+g+","+k+" "+g+","+l+" "+h+","+l}).attr("fill",function(a){return a.color});if(m.onDrawAnnotsCallback)m.onDrawAnnotsCallback()};
Ideogram.prototype.putChromosomesInRows=function(){var e=this.config.rows,f,a,c,b,d,h;f=Math.floor(this.config.chromosomes[this.config.taxid].length/e);b=0;"g"!==d3.select("svg > *")[0][0].tagName&&(b=2);for(var g=1;g<e;g++)a=f*g+1+b,c=a+f,range="nth-child(n+"+a+"):nth-child(-n+"+c+")",d=this.config.chrHeight+20,a=a+1-b,c=this.config.chrWidth,h=this.config.chrMargin*a,this.config.showBandLabels||(a+=2),this.config.showChromosomeLabels&&(d+=12),rowWidth=h+(c-4)*a+8,d3.selectAll("#ideogram .chromosome:"+
range).attr("transform",function(a,b){return d3.select(this).attr("transform")+("translate("+d+", "+rowWidth+")")})};Ideogram.prototype.onBrushMove=function(){call(this.onBrushMoveCallback)};
Ideogram.prototype.createBrush=function(e,f){var a=this,c=a.config.chrWidth+6.5,b=a.chromosomesArray[0],d=b.bands[b.bands.length-1].bp.stop,h,g;g=[0];h=[0];for(var k,l=0;l<b.bands.length;l++)k=b.bands[l],g.push(k.bp.stop),h.push(k.px.stop);b=d3.scale.linear().domain(g).range(h);g=d3.select(".band")[0][0].getBBox().y-3.25;"undefined"===typeof e&&(e=Math.floor(d/10));"undefined"===typeof right&&(f=Math.ceil(2*e));d=e;h=f;a.selectedRegion={from:e,to:f,extent:f-e};a.brush=d3.svg.brush().x(b).extent([d,
h]).on("brush",function(){var b=a.brush.extent(),c=Math.floor(b[0]),b=Math.ceil(b[1]);a.selectedRegion={from:c,to:b,extent:b-c};if(a.onBrushMove)a.onBrushMoveCallback()});d3.select("#ideogram").append("g").attr("class","brush").attr("transform","translate(0, "+g+")").call(a.brush).selectAll("rect").attr("height",c)};Ideogram.prototype.onLoad=function(){call(this.onLoadCallback)};Ideogram.prototype.onDrawAnnots=function(){call(this.onDrawAnnotsCallback)};
Ideogram.prototype.getBandColorGradients=function(){var e,f,a="";e=[["gneg","#FFF","#FFF","#DDD"],["gpos25","#C8C8C8","#DDD","#BBB"],["gpos33","#BBB","#BBB","#AAA"],["gpos50","#999","#AAA","#888"],["gpos66","#888","#888","#666"],["gpos75","#777","#777","#444"],["gpos100","#444","#666","#000"],["acen","#FEE","#FEE","#FDD"]];for(var c=0;c<e.length;c++)f=e[c][0],color1=e[c][1],color2=e[c][2],color3=e[c][3],a+='<linearGradient id="'+f+'" x1="0%" y1="0%" x2="0%" y2="100%">',a="gneg"==f?a+('<stop offset="70%" stop-color="'+
color2+'" /><stop offset="95%" stop-color="'+color3+'" /><stop offset="100%" stop-color="'+color1+'" />'):a+('<stop offset="5%" stop-color="'+color1+'" /><stop offset="15%" stop-color="'+color2+'" /><stop offset="60%" stop-color="'+color3+'" />'),a+="</linearGradient>";css='<style>.gneg {fill: url("#gneg")} .gpos25 {fill: url("#gpos25")} .gpos33 {fill: url("#gpos33")} .gpos50 {fill: url("#gpos50")} .gpos66 {fill: url("#gpos66")} .gpos75 {fill: url("#gpos75")} .gpos100 {fill: url("#gpos100")} .acen {fill: url("#acen")} .stalk {fill: url("#stalk")} .gvar {fill: url("#gvar")} </style>';
return a=css+("<defs>"+(a+'<pattern id="stalk" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#CCE" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#88B; stroke-width:0.7;" /></pattern><pattern id="gvar" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(-30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#DDF" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#99C; stroke-width:0.7;" /></pattern>')+
"</defs>")};
Ideogram.prototype.init=function(){function e(){var c,e,f,g,k,m=d.config.taxids;l=[];var r=(new Date).getTime();for(f=0;f<m.length;f++)for(a=m[f],k=d.bandData[a],b=d.config.chromosomes[a],g=0;g<b.length;g++)c=b[g],e=d.getBands(k,c,a),l.push(e),c=e[e.length-1].iscn.stop,e=e[e.length-1].bp.stop,c>d.maxLength.iscn&&(d.maxLength.iscn=c),e>d.maxLength.bp&&(d.maxLength.bp=e);f=(new Date).getTime();this.debug&&console.log("Time in getBands: "+(f-r)+" ms");k=0;r=(new Date).getTime();for(f=0;f<m.length;f++){a=
m[f];b=d.config.chromosomes[a];d.chromosomes[a]={};for(g=0;g<b.length;g++)e=l[k],k+=1,c=b[g],e=d.getChromosomeModel(e,c,a,k),d.chromosomes[a][c]=e,d.chromosomesArray.push(e),d.drawChromosome(e,k);!0===d.config.showBandLabels&&d.drawBandLabels(d.chromosomes)}for(f=k=0;f<m.length;f++)for(a=m[f],b=d.config.chromosomes[a],g=0;g<b.length;g++)k+=1,c=b[g],chrModel=d.chromosomes[a][c],chr=d3.select("#chr"+c+"-"+a),d.initTransformChromosome(chr,k);if(d.config.annotationsPath){var p=function(){"undefined"!==
typeof timeout&&window.clearTimeout(timeout);d.annots=d.processAnnotData(d.rawAnnots);d.drawAnnots(d.annots);d.initCrossFilter&&d.initCrossFilter()};d.rawAnnots?p():function t(){timeout=setTimeout(function(){d.rawAnnots?p():t()},50)}()}if(!0===d.config.showBandLabels&&(f=d.bandsToShow.join(","),m=(new Date).getTime(),d3.selectAll(".bandLabel, .bandLabelStalk").style("display","none"),d3.selectAll(f).style("display",""),f=(new Date).getTime(),this.debug&&console.log("Time in showing bands: "+(f-m)+
" ms"),"vertical"===d.config.orientation))for(m=0;m<d.chromosomesArray.length;m++)d.rotateChromosomeLabels(d3.select("#"+d.chromosomesArray[m].id),m);!0===d.config.showChromosomeLabels&&d.drawChromosomeLabels(d.chromosomes);1<d.config.rows&&d.putChromosomesInRows();!0===d.config.brush&&d.createBrush();m=(new Date).getTime();this.debug&&console.log("Time in drawChromosome: "+(m-r)+" ms");m=(new Date).getTime();this.debug&&console.log("Time constructing ideogram: "+(m-h)+" ms");if(d.onLoadCallback)d.onLoadCallback()}
var f=!0===this.config.multiorganism,a,c,b,d=this,h=(new Date).getTime();if(0==f)"undefined"==typeof this.config.taxid&&(d.config.taxid="9606"),a=this.config.taxid,c=[a],this.config.taxids=c,b=this.config.chromosomes.slice(),d.config.chromosomes={},d.config.chromosomes[a]=b;else for(d.coordinateSystem="bp",c=this.config.taxids,f=0;f<c.length;f++)a=c[f];d.config.annotationsPath&&d3.json(d.config.annotationsPath,function(a){d.rawAnnots=a});f="";d.config.showChromosomeLabels&&(f="horizontal"==d.config.orientation?
f+"labeledLeft ":f+"labeled ");this.config.annotationsLayout&&"overlay"===this.config.annotationsLayout&&(f+="faint");var g;"vertical"===d.config.orientation?(g=d.config.chrHeight+30,1<d.config.rows&&(g=d.config.rows*(g-30))):g=d.config.chrMargin*b.length+30;var k=d.getBandColorGradients();d3.select(this.config.container).append("svg").attr("id","ideogram").attr("class",f).attr("width","97%").attr("height",g).html(k);var l=[],m=0;g=this.config.resolution;for(f=0;f<c.length;f++)a=c[f],bandDataFileNames=
{9606:"ncbi/ideogram_9606_GCF_000001305.14_"+g+"_V1",10090:"ncbi/ideogram_10090_GCF_000000055.19_NA_V2",7227:"ucsc/drosophila_melanogaster_dm6.tsv"},"undefined"===typeof chrBands?d3.xhr("../data/bands/"+bandDataFileNames[a]).on("beforesend",function(b){b.taxid=a}).get(function(a,b){d.bandData[b.taxid]=b.response;m+=1;m==c.length&&e()}):(d.bandData["9606"]=chrBands,e())};
//# sourceMappingURL=ideogram.js.map
